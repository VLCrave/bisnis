<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VLCrave Delivery</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ff8c00, #ffd700);
      color: #333;
    }
    header {
      padding: 15px;
      text-align: center;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    header h1 {
      font-size: 1.8rem;
      color: #fff;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.3);
      position: sticky;
      top: 0;
      backdrop-filter: blur(6px);
    }
    nav button {
      background: #ff8c00;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    nav button:hover, nav button.active {
      background: #e67600;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
      background-color: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h2 {
      margin-bottom: 10px;
      color: #ff8c00;
      border-left: 5px solid #ffd700;
      padding-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #ff8c00;
      color: #fff;
    }
    .actions button {
      margin: 2px;
    }
    .summary {
      margin-top: 15px;
      padding: 10px;
      background: #fff8e1;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    canvas {
      margin-top: 15px;
    }
    .hidden {
      display: none;
    }
    .total-transactions {
      margin-top: 8px;
      font-weight: 700;
      color: #333;
    }
  </style>
</head>
<body>

<header>
  <h1>üìä VLCrave Delivery</h1>
</header>

<nav>
  <button id="tabDashboard" class="active" onclick="showTab('dashboard')">Dashboard</button>
  <button id="tabDaily" onclick="showTab('daily')">Laporan Harian</button>
  <button id="tabMonthly" onclick="showTab('monthly')">Laporan Bulanan</button>
</nav>

<div class="container" id="dashboard">
  <h2>üí∞ Rincian Modal</h2>
  <button onclick="addModal()">+ Tambah Modal</button>
  <table id="modalTable">
    <thead>
      <tr><th>Nama Item</th><th>Nominal</th><th>Aksi</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>üìÜ Rekap Penghasilan</h2>
  <button onclick="addIncome()">+ Tambah Penghasilan</button>
  <table id="incomeTable">
    <thead>
      <tr><th>Tanggal</th><th>Nominal</th><th>Aksi</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary">
    <h2>üìà Laporan Laba / Rugi</h2>
    <p><b>Total Modal:</b> Rp <span id="totalModal">0</span></p>
    <p><b>Total Penghasilan:</b> Rp <span id="totalIncome">0</span></p>
    <p><b>Laba/Rugi:</b> Rp <span id="profitLoss">0</span></p>
    <p><b>Persentase Profit:</b> <span id="profitPercent">0</span>%</p>
    <p><b>Net Profit per Hari:</b> Rp <span id="netProfit">0</span></p>
  </div>

  <button onclick="shareWhatsApp()">üì§ Bagikan ke WhatsApp</button>
  <button onclick="exportExcel()">üìÑ Export Excel</button>
</div>

<!-- Laporan Harian -->
<div class="container hidden" id="daily">
  <h2>üìÖ Laporan Harian</h2>
  <label>Pilih Bulan: 
    <input type="month" id="filterDaily" onchange="renderDailyReport()">
  </label>
  <table id="dailyTable">
    <thead>
      <tr><th>Tanggal</th><th>Penghasilan</th><th>Transaksi (Jumlah)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="total-transactions" id="dailyTotalTransactions">Total Transaksi (bulan): 0</div>

  <canvas id="dailyChart"></canvas>
  <button onclick="exportDailyExcel()">üìÑ Export Excel</button>
</div>

<!-- Laporan Bulanan -->
<div class="container hidden" id="monthly">
  <h2>üìÜ Laporan Bulanan</h2>
  <table id="monthlyTable">
    <thead>
      <tr><th>Bulan</th><th>Total Penghasilan</th><th>Total Transaksi</th><th>Rata-rata Harian</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <canvas id="monthlyChart"></canvas>
  <button onclick="exportMonthlyExcel()">üìÑ Export Excel</button>
</div>

<script>
let modalList = JSON.parse(localStorage.getItem("modalList")) || [];
let incomeList = JSON.parse(localStorage.getItem("incomeList")) || [];
let dailyChart, monthlyChart;

function saveData() {
  localStorage.setItem("modalList", JSON.stringify(modalList));
  localStorage.setItem("incomeList", JSON.stringify(incomeList));
  renderTables();
  renderDailyReport();
  renderMonthlyReport();
}

function addModal() {
  Swal.fire({
    title: 'Tambah Modal',
    html: '<input id="itemName" class="swal2-input" placeholder="Nama Item">' +
          '<input id="itemPrice" type="number" class="swal2-input" placeholder="Nominal">',
    confirmButtonText: 'Simpan',
    preConfirm: () => {
      const name = document.getElementById("itemName").value;
      const price = parseInt(document.getElementById("itemPrice").value) || 0;
      if (!name || price <= 0) return Swal.showValidationMessage("Lengkapi data!");
      modalList.push({ name, price });
      saveData();
    }
  });
}

function addIncome() {
  Swal.fire({
    title: 'Tambah Penghasilan',
    html: '<input id="incomeDate" type="date" class="swal2-input">' +
          '<input id="incomePrice" type="number" class="swal2-input" placeholder="Nominal">',
    confirmButtonText: 'Simpan',
    preConfirm: () => {
      const date = document.getElementById("incomeDate").value;
      const price = parseInt(document.getElementById("incomePrice").value) || 0;
      if (!date || price <= 0) return Swal.showValidationMessage("Lengkapi data!");
      incomeList.push({ date, price }); // unchanged structure; each entry = one transaksi
      saveData();
    }
  });
}

function editModal(i) {
  Swal.fire({
    title: 'Edit Modal',
    html: `<input id="editName" class="swal2-input" value="${modalList[i].name}">
           <input id="editPrice" type="number" class="swal2-input" value="${modalList[i].price}">`,
    confirmButtonText: 'Update',
    preConfirm: () => {
      modalList[i].name = document.getElementById("editName").value;
      modalList[i].price = parseInt(document.getElementById("editPrice").value);
      saveData();
    }
  });
}

function editIncome(i) {
  Swal.fire({
    title: 'Edit Penghasilan',
    html: `<input id="editDate" type="date" class="swal2-input" value="${incomeList[i].date}">
           <input id="editIncome" type="number" class="swal2-input" value="${incomeList[i].price}">`,
    confirmButtonText: 'Update',
    preConfirm: () => {
      incomeList[i].date = document.getElementById("editDate").value;
      incomeList[i].price = parseInt(document.getElementById("editIncome").value);
      saveData();
    }
  });
}

function deleteModal(i) {
  Swal.fire({
    title: 'Hapus Modal?',
    text: 'Data akan dihapus permanen!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, Hapus'
  }).then(res => {
    if (res.isConfirmed) {
      modalList.splice(i, 1);
      saveData();
    }
  });
}

function deleteIncome(i) {
  Swal.fire({
    title: 'Hapus Penghasilan?',
    text: 'Data akan dihapus permanen!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, Hapus'
  }).then(res => {
    if (res.isConfirmed) {
      incomeList.splice(i, 1);
      saveData();
    }
  });
}

function renderTables() {
  const modalTable = document.querySelector("#modalTable tbody");
  modalTable.innerHTML = "";
  modalList.forEach((m, i) => {
    modalTable.innerHTML += `<tr>
      <td>${m.name}</td>
      <td>Rp ${m.price.toLocaleString()}</td>
      <td><button onclick="editModal(${i})">‚úèÔ∏è</button>
          <button onclick="deleteModal(${i})">üóëÔ∏è</button></td>
    </tr>`;
  });

  const incomeTable = document.querySelector("#incomeTable tbody");
  incomeTable.innerHTML = "";
  incomeList.forEach((iData, i) => {
    incomeTable.innerHTML += `<tr>
      <td>${iData.date}</td>
      <td>Rp ${iData.price.toLocaleString()}</td>
      <td><button onclick="editIncome(${i})">‚úèÔ∏è</button>
          <button onclick="deleteIncome(${i})">üóëÔ∏è</button></td>
    </tr>`;
  });

  const totalModal = modalList.reduce((s, x) => s + x.price, 0);
  const totalIncome = incomeList.reduce((s, x) => s + x.price, 0);
  const profitLoss = totalIncome - totalModal;
  const profitPercent = totalModal > 0 ? ((profitLoss / totalModal) * 100).toFixed(2) : 0;
  const netProfit = incomeList.length > 0 ? (profitLoss / incomeList.length).toFixed(0) : 0;

  document.getElementById("totalModal").textContent = totalModal.toLocaleString();
  document.getElementById("totalIncome").textContent = totalIncome.toLocaleString();
  document.getElementById("profitLoss").textContent = profitLoss.toLocaleString();
  document.getElementById("profitPercent").textContent = profitPercent;
  document.getElementById("netProfit").textContent = netProfit;
}

function renderDailyReport() {
  const month = document.getElementById("filterDaily").value;
  // dailyData: { '2025-09-06': { total: 16000, transactions: 3 } }
  const dailyData = {};
  incomeList.forEach(i => {
    if (!month || i.date.startsWith(month)) {
      if (!dailyData[i.date]) dailyData[i.date] = { total: 0, transactions: 0 };
      dailyData[i.date].total += i.price;
      dailyData[i.date].transactions += 1; // each incomeList entry = 1 transaksi
    }
  });

  const dailyTable = document.querySelector("#dailyTable tbody");
  dailyTable.innerHTML = "";
  // sort dates
  const dates = Object.keys(dailyData).sort();
  let totalTransactionsInMonth = 0;
  dates.forEach(d => {
    const info = dailyData[d];
    dailyTable.innerHTML += `<tr><td>${d}</td><td>Rp ${info.total.toLocaleString()}</td><td>${info.transactions}</td></tr>`;
    totalTransactionsInMonth += info.transactions;
  });

  document.getElementById("dailyTotalTransactions").textContent = `Total Transaksi (bulan): ${totalTransactionsInMonth}`;

  const ctx = document.getElementById("dailyChart").getContext("2d");
  if (dailyChart) dailyChart.destroy();
  dailyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: dates,
      datasets: [{
        label: "Penghasilan Harian",
        data: dates.map(d => dailyData[d].total),
        borderColor: "#ff8c00",
        backgroundColor: "rgba(255,140,0,0.3)",
        tension: 0.3
      },{
        label: "Transaksi Harian",
        data: dates.map(d => dailyData[d].transactions),
        borderColor: "#333333",
        backgroundColor: "rgba(51,51,51,0.2)",
        yAxisID: 'y2',
        tension: 0.3
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true },
        y2: {
          position: 'right',
          beginAtZero: true,
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function renderMonthlyReport() {
  // monthlyData: { '2025-09': { total: 160000, transactions: 42, daysCount: 10 } }
  const monthlyData = {};
  incomeList.forEach(i => {
    const month = i.date.slice(0, 7);
    if (!monthlyData[month]) monthlyData[month] = { total: 0, transactions: 0, days: {} };
    monthlyData[month].total += i.price;
    monthlyData[month].transactions += 1; // each income entry counts as one transaksi
    monthlyData[month].days[i.date] = true; // track distinct days
  });

  const monthlyTable = document.querySelector("#monthlyTable tbody");
  monthlyTable.innerHTML = "";
  const months = Object.keys(monthlyData).sort();
  months.forEach(m => {
    const info = monthlyData[m];
    const distinctDays = Object.keys(info.days).length || 1;
    const avg = Math.round(info.total / distinctDays);
    monthlyTable.innerHTML += `<tr><td>${m}</td><td>Rp ${info.total.toLocaleString()}</td><td>${info.transactions}</td><td>Rp ${avg.toLocaleString()}</td></tr>`;
  });

  const ctx = document.getElementById("monthlyChart").getContext("2d");
  if (monthlyChart) monthlyChart.destroy();
  monthlyChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: months,
      datasets: [{
        label: "Penghasilan Bulanan",
        data: months.map(m => monthlyData[m].total),
        backgroundColor: "#ffd700"
      },{
        label: "Total Transaksi Bulanan",
        data: months.map(m => monthlyData[m].transactions),
        backgroundColor: "#ff8c00",
        yAxisID: 'y2'
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true },
        y2: {
          position: 'right',
          beginAtZero: true,
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function shareWhatsApp() {
  const totalModal = modalList.reduce((s, x) => s + x.price, 0);
  const totalIncome = incomeList.reduce((s, x) => s + x.price, 0);
  const profitLoss = totalIncome - totalModal;
  const profitPercent = totalModal > 0 ? ((profitLoss / totalModal) * 100).toFixed(2) : 0;

  // also include total transactions overall
  const totalTransactions = incomeList.length;

  let msg = `*VLCrave Business Page*%0A%0Aüí∞ Total Modal: Rp ${totalModal.toLocaleString()}%0Aüìà Total Penghasilan: Rp ${totalIncome.toLocaleString()}%0Aüíπ Laba/Rugi: Rp ${profitLoss.toLocaleString()}%0Aüìä Persentase Profit: ${profitPercent}%0Aüßæ Total Transaksi: ${totalTransactions}`;
  window.open(`https://wa.me/?text=${msg}`, "_blank");
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet([
    ...modalList.map(m => ({ Kategori: "Modal", Nama: m.name, Nominal: m.price })),
    ...incomeList.map(i => ({ Kategori: "Penghasilan", Tanggal: i.date, Nominal: i.price }))
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Laporan VLCrave");
  XLSX.writeFile(wb, "VLCrave_Business_Report.xlsx");
}

function exportDailyExcel() {
  // build sheet with date, total, transactions
  const month = document.getElementById("filterDaily").value;
  const dailyData = {};
  incomeList.forEach(i => {
    if (!month || i.date.startsWith(month)) {
      if (!dailyData[i.date]) dailyData[i.date] = { total: 0, transactions: 0 };
      dailyData[i.date].total += i.price;
      dailyData[i.date].transactions += 1;
    }
  });
  const rows = Object.keys(dailyData).sort().map(d => ({ Tanggal: d, Penghasilan: dailyData[d].total, Transaksi: dailyData[d].transactions }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Laporan Harian");
  XLSX.writeFile(wb, "Laporan_Harian_VLCrave.xlsx");
}

function exportMonthlyExcel() {
  const monthlyData = {};
  incomeList.forEach(i => {
    const m = i.date.slice(0,7);
    if (!monthlyData[m]) monthlyData[m] = { total:0, transactions:0, days:{} };
    monthlyData[m].total += i.price;
    monthlyData[m].transactions += 1;
    monthlyData[m].days[i.date] = true;
  });
  const rows = Object.keys(monthlyData).sort().map(m => {
    const days = Object.keys(monthlyData[m].days).length || 1;
    const avg = Math.round(monthlyData[m].total / days);
    return { Bulan: m, TotalPenghasilan: monthlyData[m].total, TotalTransaksi: monthlyData[m].transactions, RataRataHarian: avg };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Laporan Bulanan");
  XLSX.writeFile(wb, "Laporan_Bulanan_VLCrave.xlsx");
}

function showTab(tab) {
  document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
  document.getElementById(tab).classList.remove("hidden");
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add("active");
}

renderTables();
renderDailyReport();
renderMonthlyReport();
</script>

</body>
</html>
