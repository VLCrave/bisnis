<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CraveStreet - Sistem Keuangan</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; transition:0.3s; }
    header { background:#333; color:#fff; padding:15px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; }
    nav { display:flex; gap:15px; }
    nav a { color:#fff; text-decoration:none; cursor:pointer; }
    .dark { background:#121212; color:#f1f1f1; }
    .container { padding:20px; }
    .card { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .dark .card { background:#1e1e1e; color:#f1f1f1; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .tabs button { padding:10px 15px; border:none; cursor:pointer; border-radius:5px; background:#ddd; }
    .tabs button.active { background:#333; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border:1px solid #ccc; text-align:left; }
    .floating { position:fixed; bottom:20px; right:20px; background:red; color:#fff; padding:10px 15px; border-radius:5px; display:none; }
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-store"></i> CraveStreet - Sistem Keuangan</h1>
    <nav>
      <a onclick="setTab('dashboard')"><i class="fa-solid fa-gauge"></i> Dashboard</a>
      <a onclick="setTab('cashflow')"><i class="fa-solid fa-money-bill-transfer"></i> Arus Kas</a>
      <a onclick="setTab('transactions')"><i class="fa-solid fa-list"></i> Riwayat</a>
      <a onclick="setTab('leaderboard')"><i class="fa-solid fa-trophy"></i> Leaderboard</a>
      <a onclick="setTab('stok')"><i class="fa-solid fa-boxes-stacked"></i> Stok</a>
      <a onclick="toggleDark()"><i class="fa-solid fa-moon"></i></a>
    </nav>
  </header>

  <div class="container">
    <div class="tabs">
      <button onclick="setTab('dashboard')" id="tab-dashboard" class="active">Dashboard</button>
      <button onclick="setTab('cashflow')" id="tab-cashflow">Arus Kas</button>
      <button onclick="setTab('transactions')" id="tab-transactions">Riwayat Transaksi</button>
      <button onclick="setTab('leaderboard')" id="tab-leaderboard">Leaderboard</button>
      <button onclick="setTab('stok')" id="tab-stok">Stok Barang</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="card">
      <h2><i class="fa-solid fa-chart-line"></i> Statistik</h2>
      <label>Filter: 
        <select id="filter" onchange="loadStats()">
          <option value="daily">Harian</option>
          <option value="weekly">Mingguan</option>
          <option value="monthly">Bulanan</option>
        </select>
      </label>
      <p><i class="fa-solid fa-sack-dollar"></i> Total Pemasukan: <span id="income">Rp0</span></p>
      <p><i class="fa-solid fa-coins"></i> Total Pengeluaran: <span id="expense">Rp0</span></p>
      <p><i class="fa-solid fa-wallet"></i> Laba Bersih: <span id="profit">Rp0</span></p>
    </div>

    <!-- Arus Kas -->
    <div id="cashflow" class="card" style="display:none;">
      <h2><i class="fa-solid fa-money-bill-wave"></i> Arus Kas Realtime</h2>
      <p>Total Kas: <span id="cash">Rp0</span></p>
    </div>

    <!-- Riwayat Transaksi -->
    <div id="transactions" class="card" style="display:none;">
      <h2><i class="fa-solid fa-receipt"></i> Riwayat Transaksi</h2>
      <table>
        <thead><tr><th>Tanggal</th><th>Jenis</th><th>Nominal</th><th>Customer/Deskripsi</th></tr></thead>
        <tbody id="transaction-list"></tbody>
      </table>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="card" style="display:none;">
      <h2><i class="fa-solid fa-ranking-star"></i> Leaderboard Penjualan</h2>
      <table>
        <thead><tr><th>Nama Customer</th><th>Total Belanja</th></tr></thead>
        <tbody id="leaderboard-list"></tbody>
      </table>
    </div>

    <!-- Manajemen Stok -->
    <div id="stok" class="card" style="display:none;">
      <h2><i class="fa-solid fa-box"></i> Manajemen Stok Barang</h2>
      <button onclick="addStok()">+ Tambah Barang</button>
      <table>
        <thead><tr><th>Nama</th><th>Harga</th><th>Jumlah</th><th>Aksi</th></tr></thead>
        <tbody id="stok-list"></tbody>
      </table>
    </div>

    <!-- Form Input -->
    <div class="card">
      <h2><i class="fa-solid fa-pen-to-square"></i> Input Transaksi</h2>
      <button onclick="addIncome()">+ Tambah Penjualan</button>
      <button onclick="addExpense()">+ Tambah Pengeluaran</button>
    </div>
  </div>

  <div class="floating" id="notif">⚠️ Stok beberapa barang kurang dari 5!</div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzzr0ChjdVi7m4Ge-EFm3OK43ASujjZ40",
      authDomain: "crave-street-id.firebaseapp.com",
      projectId: "crave-street-id",
      storageBucket: "crave-street-id.appspot.com",
      messagingSenderId: "221955592583",
      appId: "1:221955592583:web:43dc59d791e750095cc322"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const colTrans = collection(db, "transactions");
    const colStok = collection(db, "stok");

    function setTab(tab) {
      document.querySelectorAll(".card").forEach(c => c.style.display="none");
      document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
      document.getElementById(tab).style.display="block";
      document.getElementById("tab-"+tab).classList.add("active");
    }

    function toggleDark(){ document.body.classList.toggle("dark"); }

    // Input Penjualan
    async function addIncome(){
      let stokSnap = await getDocs(colStok);
      let list = "";
      stokSnap.forEach(doc=>{
        let d=doc.data();
        list+=`<label><input type='checkbox' value='${doc.id}' data-nama='${d.nama}' data-harga='${d.harga}' data-stok='${d.jumlah}'> ${d.nama} (Stok:${d.jumlah}, Rp${d.harga})</label><br>`;
      });

      Swal.fire({
        title:"Tambah Penjualan",
        html:`
          <input id="cust" class="swal2-input" placeholder="Nama Customer">
          ${list}
          <input id="jumlah" class="swal2-input" type="number" placeholder="Jumlah per produk (default=1)">
          <input id="nominal" class="swal2-input" type="number" placeholder="Total Nominal">`,
        focusConfirm:false,
        preConfirm:()=>{
          return {
            cust:document.getElementById("cust").value,
            jumlah:parseInt(document.getElementById("jumlah").value)||1,
            nominal:parseInt(document.getElementById("nominal").value)||0,
            produk:[...document.querySelectorAll("input[type=checkbox]:checked")].map(cb=>({id:cb.value,nama:cb.dataset.nama}))
          }
        }
      }).then(async res=>{
        if(res.isConfirmed){
          // update stok
          for(let p of res.value.produk){
            let stokDoc=doc(db,"stok",p.id);
            let jumlahBaru=(res.value.jumlah);
            let snap=await getDocs(colStok);
            snap.forEach(async d=>{
              if(d.id==p.id){
                let s=d.data().jumlah - jumlahBaru;
                if(s<0) s=0;
                await updateDoc(stokDoc,{jumlah:s});
              }
            });
          }
          await addDoc(colTrans,{
            jenis:"income",
            customer:res.value.cust,
            nominal:res.value.nominal,
            produk:res.value.produk.map(x=>x.nama),
            tgl:new Date()
          });
          Swal.fire("Berhasil","Penjualan dicatat!","success");
        }
      });
    }

    // Input Pengeluaran
    function addExpense(){
      Swal.fire({
        title:"Tambah Pengeluaran",
        html:`<input id="ket" class="swal2-input" placeholder="Deskripsi">
              <input id="nominal" type="number" class="swal2-input" placeholder="Nominal">`,
        preConfirm:()=>{
          return {
            ket:document.getElementById("ket").value,
            nominal:parseInt(document.getElementById("nominal").value)||0
          }
        }
      }).then(async res=>{
        if(res.isConfirmed){
          await addDoc(colTrans,{
            jenis:"expense",
            deskripsi:res.value.ket,
            nominal:res.value.nominal,
            tgl:new Date()
          });
          Swal.fire("Berhasil","Pengeluaran dicatat!","success");
        }
      });
    }

    // CRUD Stok
    function addStok(){
      Swal.fire({
        title:"Tambah Barang",
        html:`<input id="nama" class="swal2-input" placeholder="Nama Barang">
              <input id="harga" class="swal2-input" type="number" placeholder="Harga">
              <input id="jumlah" class="swal2-input" type="number" placeholder="Jumlah">`,
        preConfirm:()=>{
          return {
            nama:document.getElementById("nama").value,
            harga:parseInt(document.getElementById("harga").value)||0,
            jumlah:parseInt(document.getElementById("jumlah").value)||0
          }
        }
      }).then(async res=>{
        if(res.isConfirmed){
          await addDoc(colStok,res.value);
          Swal.fire("Berhasil","Barang ditambahkan!","success");
        }
      });
    }

    async function editStok(id,nama,harga,jumlah){
      Swal.fire({
        title:"Edit Barang",
        html:`<input id="nama" class="swal2-input" value="${nama}">
              <input id="harga" class="swal2-input" type="number" value="${harga}">
              <input id="jumlah" class="swal2-input" type="number" value="${jumlah}">`,
        preConfirm:()=>{
          return {
            nama:document.getElementById("nama").value,
            harga:parseInt(document.getElementById("harga").value)||0,
            jumlah:parseInt(document.getElementById("jumlah").value)||0
          }
        }
      }).then(async res=>{
        if(res.isConfirmed){
          await updateDoc(doc(db,"stok",id),res.value);
          Swal.fire("Berhasil","Barang diupdate!","success");
        }
      });
    }

    async function deleteStok(id){
      if(confirm("Yakin hapus barang ini?")){
        await deleteDoc(doc(db,"stok",id));
      }
    }

    // Listener transaksi realtime
    onSnapshot(query(colTrans,orderBy("tgl","desc")),(snap)=>{
      let rows="";
      let leaderboard={};
      snap.forEach(doc=>{
        let d=doc.data();
        if(d.jenis=="income"){
          rows+=`<tr><td>${new Date(d.tgl.seconds*1000).toLocaleString()}</td><td>Pemasukan</td><td>Rp${d.nominal}</td><td>${d.customer}</td></tr>`;
          leaderboard[d.customer]=(leaderboard[d.customer]||0)+d.nominal;
        } else {
          rows+=`<tr><td>${new Date(d.tgl.seconds*1000).toLocaleString()}</td><td>Pengeluaran</td><td>Rp${d.nominal}</td><td>${d.deskripsi}</td></tr>`;
        }
      });
      document.getElementById("transaction-list").innerHTML=rows;

      // Leaderboard
      let lb="";
      Object.keys(leaderboard).sort((a,b)=>leaderboard[b]-leaderboard[a]).forEach(c=>{
        lb+=`<tr><td>${c}</td><td>Rp${leaderboard[c]}</td></tr>`;
      });
      document.getElementById("leaderboard-list").innerHTML=lb;

      loadStats();
    });

    // Listener stok realtime
    onSnapshot(colStok,(snap)=>{
      let rows="";
      let kurang=false;
      snap.forEach(doc=>{
        let d=doc.data();
        rows+=`<tr><td>${d.nama}</td><td>Rp${d.harga}</td><td>${d.jumlah}</td>
        <td><button onclick="editStok('${doc.id}','${d.nama}',${d.harga},${d.jumlah})">Edit</button>
        <button onclick="deleteStok('${doc.id}')">Hapus</button></td></tr>`;
        if(d.jumlah<5) kurang=true;
      });
      document.getElementById("stok-list").innerHTML=rows;
      document.getElementById("notif").style.display=kurang?"block":"none";
    });

    async function loadStats(){
      let filter=document.getElementById("filter").value;
      let snap=await getDocs(colTrans);
      let income=0,expense=0;
      snap.forEach(doc=>{
        let d=doc.data();
        let t=new Date(d.tgl.seconds*1000);
        let now=new Date();
        let include=false;
        if(filter=="daily"){ include=t.toDateString()==now.toDateString(); }
        if(filter=="weekly"){
          let weekStart=new Date(); weekStart.setDate(now.getDate()-now.getDay());
          include=t>=weekStart;
        }
        if(filter=="monthly"){ include=t.getMonth()==(new Date()).getMonth(); }
        if(include){
          if(d.jenis=="income") income+=d.nominal;
          if(d.jenis=="expense") expense+=d.nominal;
        }
      });
      document.getElementById("income").innerText="Rp"+income;
      document.getElementById("expense").innerText="Rp"+expense;
      document.getElementById("profit").innerText="Rp"+(income-expense);
      document.getElementById("cash").innerText="Rp"+(income-expense);
    }
  </script>
</body>
</html>
